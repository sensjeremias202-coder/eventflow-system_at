<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificar Conta - Eventflow</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../styles.css">
  <script src="../config.js"></script>
  <script src="../api.js"></script>
  <style>
    .verify-container { max-width: 520px; margin: 10vh auto; background:#fff; border-radius:16px; box-shadow:0 12px 32px rgba(0,0,0,.12); padding:24px; }
    .verify-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .methods { display:flex; gap:8px; margin: 12px 0; }
    .methods button { padding:8px 12px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; cursor:pointer }
    .code-input { width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; letter-spacing:4px; text-align:center; }
    .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  </style>
</head>
<body>
  <script> if (!localStorage.getItem('token')) { window.location.href = '../login-firebase.html'; } </script>
  <div class="verify-container">
    <div class="verify-header">
      <i class="fas fa-shield-alt"></i>
      <h2 style="margin:0">Verifique sua conta</h2>
    </div>
    <p>Receba seu código de verificação via WhatsApp e confirme sua conta.</p>

    <div class="methods">
      <button id="methodWhatsApp"><i class="fab fa-whatsapp"></i> WhatsApp</button>
    </div>

    <div class="form-group" id="phoneGroup" style="display:block;margin-bottom:8px">
      <label for="phone"><i class="fas fa-phone"></i> Telefone (com DDI/DDD):</label>
      <input type="tel" id="phone" placeholder="+55DDDNUMERO" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px" />
    </div>

    <div id="qrSection" style="display:none; margin:12px 0; text-align:center">
      <p style="color:#2e5051; margin-bottom:8px"><i class="fab fa-whatsapp"></i> Escaneie para abrir conversa no WhatsApp</p>
      <img id="qrImage" alt="QR WhatsApp" style="width:200px;height:200px;border:1px solid #eee;border-radius:8px" />
      <div style="font-size:12px;color:#777;margin-top:6px">Dica: adicione o contato para facilitar verificações futuras.</div>
    </div>

    <div id="requestStatus" style="color:#2e5051;margin-bottom:8px"></div>

    <input type="text" id="code" class="code-input" placeholder="000000" maxlength="6" />

    <div class="actions">
      <button class="btn btn-secondary" id="resendBtn"><i class="fas fa-redo"></i> Reenviar código</button>
      <button class="btn btn-primary" id="confirmBtn"><i class="fas fa-check"></i> Confirmar</button>
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #eee"/>

    <div id="totpSection">
      <h3 style="margin:0 0 8px 0"><i class="fas fa-mobile-alt"></i> Autenticação de Dois Fatores (TOTP)</h3>
      <p style="color:#555">Opcional: proteja seu acesso com Google Authenticator ou similar.</p>
      <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap">
        <button class="btn btn-secondary" id="setupTotpBtn"><i class="fas fa-qrcode"></i> Gerar QR TOTP</button>
        <div id="totpInfo" style="display:none">
          <div style="margin:8px 0">
            <img id="totpQr" alt="QR TOTP" style="width:200px;height:200px;border:1px solid #eee;border-radius:8px" />
          </div>
          <div style="font-size:12px;color:#777">Segredo (Base32): <span id="totpSecret" style="font-weight:600;color:#2e5051"></span></div>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center">
        <input type="text" id="totpCode" placeholder="Código TOTP (000000)" style="flex:1;padding:10px;border:2px solid #ddd;border-radius:8px"/>
        <button class="btn btn-primary" id="enableTotpBtn"><i class="fas fa-shield-alt"></i> Habilitar 2FA</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <a href="../index.html" class="btn btn-secondary"><i class="fas fa-home"></i> Início</a>
    </div>
  </div>

  <script>
    let currentMethod = 'whatsapp';
    async function requestCode(method){
      try {
        currentMethod = method;
        const phone = document.getElementById('phone')?.value?.trim();
        const body = (method === 'phone' || method === 'whatsapp') ? { method, phone } : { method };
        const res = await api.post('/auth/request-verification', body, { auth: true });
        const data = res.ok ? await res.json() : { error: 'Falha ao solicitar' };
        const msg = 'Código enviado por WhatsApp.';
        document.getElementById('requestStatus').textContent = res.ok ? msg : (data.error||'Erro');
        // Se for WhatsApp e telefone informado, exibe QR para abrir conversa
        const qrSection = document.getElementById('qrSection');
        const qrImage = document.getElementById('qrImage');
        if (method === 'whatsapp' && phone) {
          try {
            const waUrl = `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent('Olá, quero verificar minha conta Eventflow.')}`;
            // Usando serviço público de QR
            qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(waUrl)}`;
            qrSection.style.display = 'block';
          } catch(_) { qrSection.style.display = 'none'; }
        } else {
          qrSection.style.display = 'none';
        }
      } catch(err){ document.getElementById('requestStatus').textContent = 'Erro ao solicitar código'; }
    }
    async function confirm(){
      const code = document.getElementById('code').value.trim();
      if (!code) { alert('Informe o código'); return; }
      try {
        const res = await api.post('/auth/verify', { code }, { auth: true });
        const data = await res.json().catch(()=>({}));
        if (res.ok) { alert('Conta verificada!'); window.location.href = 'dashboard.html'; }
        else { alert(data.error || 'Código inválido'); }
      } catch(err){ alert('Erro ao confirmar'); }
    }
    document.getElementById('methodWhatsApp').onclick = () => { document.getElementById('phoneGroup').style.display='block'; requestCode('whatsapp'); };
    document.getElementById('resendBtn').onclick = () => requestCode(currentMethod);
    document.getElementById('confirmBtn').onclick = confirm;

    // TOTP handlers
    document.getElementById('setupTotpBtn').onclick = async () => {
      try {
        const res = await api.post('/auth/totp/setup', {}, { auth: true });
        const data = await res.json();
        if (!res.ok) { alert(data.error || 'Falha ao gerar TOTP'); return; }
        const { base32, otpauth_url } = data;
        document.getElementById('totpSecret').textContent = base32 || '';
        const img = document.getElementById('totpQr');
        img.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(otpauth_url)}`;
        document.getElementById('totpInfo').style.display = 'block';
      } catch (e) { alert('Erro ao gerar QR TOTP'); }
    };
    document.getElementById('enableTotpBtn').onclick = async () => {
      try {
        const code = document.getElementById('totpCode').value.trim();
        if (!code) { alert('Informe o código TOTP'); return; }
        const res = await api.post('/auth/totp/enable', { code }, { auth: true });
        const data = await res.json();
        if (res.ok) { alert('2FA habilitada com sucesso'); }
        else { alert(data.error || 'Falha ao habilitar 2FA'); }
      } catch (e) { alert('Erro ao habilitar 2FA'); }
    };

    // Dica: informe seu telefone e clique em "Reenviar código" para receber por WhatsApp.
  </script>
</body>
</html>
