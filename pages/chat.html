<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventflow - Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="../styles.css">
    <script src="../config.js"></script>
    <script src="../api.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" integrity="sha384-z3r7Y6uX1p3VYmc2bHcy3WgWmFdoH2cWc3cHkH0zYpZ2cKJrTz1OeC3p0sS7nK9X" crossorigin="anonymous"></script>
    <style>
        :root {
            --whatsapp-green: #25D366;
            --whatsapp-dark: #075E54;
            --whatsapp-light: #128C7E;
            --whatsapp-chat-bg: #e5ddd5;
            --whatsapp-message-sent: #dcf8c6;
            --whatsapp-message-received: #ffffff;
            --whatsapp-timestamp: #667781;
            --whatsapp-icon: #54656f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--whatsapp-chat-bg);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-height: 100vh;
        }

        /* Sidebar Principal */
        .sidebar {
            width: 380px;
            background: white;
            border-right: 1px solid #e1e1e1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px 16px;
            background: var(--whatsapp-dark);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 24px;
            color: var(--whatsapp-green);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f0f2f5;
            border-bottom: 1px solid #e1e1e1;
        }

        .user-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--whatsapp-dark);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .user-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--whatsapp-green);
            position: absolute;
            bottom: 0;
            right: 0;
            border: 2px solid white;
        }

        /* Lista de Conversas */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        /* Busca de conversas */
        .conversation-search {
            padding: 10px 16px;
            border-bottom: 1px solid #e1e1e1;
            background: #f7f8f9;
        }
        .conversation-search input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #dfe3e6;
            font-size: 14px;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f2f5;
            transition: background 0.2s;
            position: relative;
        }

        .conversation-item:hover {
            background: #f5f5f5;
        }

        .conversation-item.active {
            background: #f0f2f5;
        }

        .conversation-avatar {
            position: relative;
        }

        .conversation-avatar-img {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--whatsapp-dark), var(--whatsapp-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 600;
        }

        .online-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--whatsapp-green);
            border: 2px solid white;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-name {
            font-size: 17px;
            font-weight: 500;
            color: #111b21;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--whatsapp-timestamp);
            font-weight: 400;
        }

        .conversation-last {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .conversation-preview {
            font-size: 14px;
            color: #667781;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .conversation-badge {
            background: var(--whatsapp-green);
            color: white;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            margin-left: 8px;
        }

        /* Área de Chat */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--whatsapp-chat-bg);
            position: relative;
            overflow: hidden;
        }

        .chat-area::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
            opacity: 0.06;
            z-index: 0;
        }

        .chat-header {
            background: #f0f2f5;
            padding: 16px 20px;
            border-left: 1px solid #e1e1e1;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1;
            position: relative;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chat-user-avatar {
            position: relative;
        }

        .chat-user-avatar-img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--whatsapp-dark), var(--whatsapp-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
        }

        .chat-user-details h3 {
            font-size: 18px;
            font-weight: 500;
            color: #111b21;
            margin-bottom: 4px;
        }

        .chat-user-details p {
            font-size: 13px;
            color: #667781;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--whatsapp-icon);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: background 0.2s;
        }

        .chat-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Mensagens */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .no-chat-selected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #667781;
            padding: 40px;
        }

        .no-chat-selected i {
            font-size: 120px;
            color: #d1d7db;
            margin-bottom: 24px;
        }

        .no-chat-selected h3 {
            font-size: 32px;
            font-weight: 300;
            color: #41525d;
            margin-bottom: 8px;
        }

        .no-chat-selected p {
            font-size: 14px;
            color: #667781;
            margin-bottom: 24px;
        }

        .message-group {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .message-group.sent {
            align-items: flex-end;
        }

        .message-group.received {
            align-items: flex-start;
        }

        .message-group-date {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-separator {
            background: rgba(0, 0, 0, 0.1);
            color: #fff;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12.5px;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.15);
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 65%;
        }

        .message-item {
            margin-bottom: 4px;
            display: flex;
            flex-direction: column;
        }

        .message-item.sent {
            align-items: flex-end;
        }

        .message-item.received {
            align-items: flex-start;
        }

        .message-content {
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            font-size: 14.2px;
            line-height: 1.4;
            max-width: 100%;
        }

        .message-sender {
            font-size: 12px;
            color: #54656f;
            margin: 0 0 2px 2px;
        }

        .message-item.sent .message-content {
            background: var(--whatsapp-message-sent);
            border-top-right-radius: 0;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .message-item.received .message-content {
            background: var(--whatsapp-message-received);
            border-top-left-radius: 0;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .message-info {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }

        .message-time {
            font-size: 11px;
            color: var(--whatsapp-timestamp);
            white-space: nowrap;
        }

        .message-status {
            font-size: 10px;
            color: var(--whatsapp-timestamp);
        }

        .message-status i {
            font-size: 12px;
        }

        .message-status .sent { color: #667781; }
        .message-status .delivered { color: #667781; }
        .message-status .read { color: #34b7f1; }

        /* Input de Mensagem */
        .message-input-container {
            background: #f0f2f5;
            padding: 12px 20px;
            border-left: 1px solid #e1e1e1;
            border-top: 1px solid #e1e1e1;
            z-index: 1;
            position: relative;
        }

        .message-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: white;
            border-radius: 8px;
            padding: 5px 12px;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 5px;
        }

        .emoji-btn, .attachment-btn, .voice-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--whatsapp-icon);
            cursor: pointer;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .emoji-btn:hover, .attachment-btn:hover, .voice-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 0;
            overflow-y: auto;
            font-size: 15px;
            line-height: 1.4;
            outline: none;
            border: none;
            resize: none;
            font-family: inherit;
        }

        .message-input:empty::before {
            content: "Digite uma mensagem";
            color: #9ca3a9;
        }

        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--whatsapp-green);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
            margin-bottom: 5px;
        }

        .send-button:hover {
            background: #1da851;
        }

        .send-button:disabled {
            background: #919191;
            cursor: not-allowed;
        }

        /* Modal e outras melhorias */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 17px 50px rgba(0, 0, 0, 0.19), 0 12px 15px rgba(0, 0, 0, 0.24);
        }

        /* Scrollbar personalizada no estilo WhatsApp */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Animações */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-item {
            animation: slideIn 0.2s ease;
        }

        /* Status de digitação */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            align-self: flex-start;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            width: fit-content;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #9ca3a9;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: transform 0.3s ease;
            }
            
            .sidebar.hidden {
                transform: translateX(-100%);
            }
            
            .chat-area {
                width: 100%;
            }
            
            .message-wrapper {
                max-width: 80%;
            }
        }
    </style>
</head>
<body>
    <script>
    if (!localStorage.getItem('token')) {
        window.location.href = '../login-firebase.html';
    }
    </script>

    <div class="app-container">
        <!-- Sidebar de Conversas -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-comments"></i>
                    <span class="logo-text">Eventflow Chat</span>
                </div>
                <button class="chat-action-btn" id="toggleSidebarBtn" title="Mostrar/ocultar lista">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="chat-action-btn" id="newChatBtn" title="Nova conversa">
                    <i class="fas fa-edit"></i>
                </button>
            </div>

            <!-- Busca de Conversas -->
            <div class="conversation-search">
                <input type="text" id="conversationSearchInput" placeholder="Buscar conversas..." aria-label="Buscar conversas">
            </div>

            <!-- Status do Usuário -->
            <div class="sidebar-user">
                <div class="conversation-avatar">
                    <div class="conversation-avatar-img" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="online-status"></div>
                </div>
                <div class="conversation-info">
                    <div class="conversation-header">
                        <div class="conversation-name" id="userName">Carregando...</div>
                    </div>
                    <div class="conversation-last">
                        <div class="conversation-preview">Online</div>
                    </div>
                </div>
                <button class="chat-action-btn" id="menuBtn" title="Menu">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>

            <!-- Lista de Conversas -->
            <div class="conversations-list" id="conversationsList">
                <!-- Conversas serão carregadas via JavaScript -->
            </div>
        </div>

        <!-- Área de Chat Principal -->
        <div class="chat-area" id="chatArea">
            <!-- Cabeçalho do Chat -->
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="chat-user-info" id="chatUserInfo">
                    <div class="chat-user-avatar">
                        <div class="chat-user-avatar-img">
                            <i class="fas fa-comments"></i>
                        </div>
                    </div>
                    <div class="chat-user-details">
                        <h3 id="chatWithName">Selecione uma conversa</h3>
                        <p id="chatStatus">Clique em uma conversa para começar</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" id="backToListBtn" title="Voltar para lista">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button class="chat-action-btn" title="Informações">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Mensagens -->
            <div class="messages-container" id="messagesContainer">
                <div class="no-chat-selected" id="noChatSelected">
                    <i class="fas fa-comments"></i>
                    <h3>Selecione uma conversa</h3>
                    <p>Escolha uma conversa na lista para começar a enviar mensagens</p>
                </div>
                <!-- Mensagens serão carregadas aqui -->
            </div>

            <!-- Input de Mensagem -->
            <div class="message-input-container" id="messageInputContainer" style="display: none;">
                <div class="message-input-wrapper">
                    <div class="input-actions">
                        <button class="emoji-btn" id="emojiBtn" title="Emoji">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="attachment-btn" id="attachmentBtn" title="Anexar arquivo">
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                    <div class="message-input" contenteditable="true" id="messageInput"
                         role="textbox" aria-label="Digite sua mensagem" aria-multiline="true"></div>
                    <button class="voice-btn" id="voiceBtn" title="Gravar áudio" style="display: none;">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="send-button" id="sendMessageBtn" title="Enviar mensagem">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <input type="file" id="attachmentInput" accept="image/*" style="display:none" aria-hidden="true" />
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Novo Chat -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <div class="chat-header">
                <div class="chat-user-info">
                    <button class="chat-action-btn" id="modalBackBtn" title="Voltar">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-user-details">
                        <h3>Nova Conversa</h3>
                    </div>
                </div>
            </div>
            <div class="messages-container" style="background: white; padding: 0;">
                <div style="display:flex; gap:8px; padding:10px 16px; border-bottom:1px solid #eee; align-items:center;">
                    <button class="chat-action-btn" id="tabUsersBtn" title="Usuários" style="background:#e9edef;border-radius:6px;width:auto;height:auto;padding:6px 10px;color:#111b21;font-size:14px;">Usuários</button>
                    <button class="chat-action-btn" id="tabEventsBtn" title="Eventos" style="background:#e9edef;border-radius:6px;width:auto;height:auto;padding:6px 10px;color:#111b21;font-size:14px;">Eventos</button>
                    <label style="margin-left:auto; display:flex; align-items:center; gap:6px; color:#667781; font-size:13px;">
                        <input type="checkbox" id="onlyOnlineToggle">
                        Apenas online
                    </label>
                </div>
                <div class="event-list" id="eventList" style="padding: 16px;">
                    <!-- Lista dinâmica: usuários ou eventos -->
                </div>
                <div style="display:flex; justify-content:flex-end; gap:8px; padding:10px 16px; border-top:1px solid #eee; background:#fafafa;">
                    <button class="chat-action-btn" id="startDmBtn" title="Iniciar conversa" style="background: var(--whatsapp-green); color: white; border-radius:6px; width:auto; height:auto; padding:6px 12px; font-size:14px;" disabled>
                        <i class="fas fa-paper-plane" style="margin-right:6px;"></i> Criar conversa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados de exemplo no estilo WhatsApp
        const conversationsData = [
            {
                id: 1,
                name: "Conferência Tech 2024",
                lastMessage: "Olá! Alguém tem dúvidas sobre a programação?",
                time: "10:30",
                unread: 2,
                participants: ["João Silva", "Maria Santos", "Carlos Oliveira"],
                eventId: 1,
                isGroup: true,
                lastSeen: "10:45",
                online: true
            },
            {
                id: 2,
                name: "Maria Santos",
                lastMessage: "Material do workshop já está disponível",
                time: "Ontem",
                unread: 0,
                participants: ["João Silva", "Ana Costa"],
                eventId: 2,
                isGroup: false,
                lastSeen: "Última vez hoje às 11:20",
                online: true
            },
            {
                id: 3,
                name: "Pedro Almeida",
                lastMessage: "Lembrando que amanhã começamos às 8:30",
                time: "Seg",
                unread: 1,
                participants: ["João Silva", "Pedro Almeida"],
                eventId: 3,
                isGroup: false,
                lastSeen: "Online",
                online: true
            },
            {
                id: 4,
                name: "Workshop Design",
                lastMessage: "Não se esqueçam de trazer seus notebooks!",
                time: "Sáb",
                unread: 0,
                participants: ["João Silva", "Ana", "Carlos", "Beatriz"],
                eventId: 4,
                isGroup: true,
                lastSeen: "",
                online: false
            }
        ];

        const messagesData = {
            1: [
                {
                    id: 1,
                    sender: "Maria Santos",
                    message: "Olá pessoal! Alguém tem dúvidas sobre a programação do evento?",
                    time: "10:30",
                    type: "received",
                    status: "read",
                    date: "Hoje"
                },
                {
                    id: 2,
                    sender: "João Silva",
                    message: "Sim, gostaria de saber sobre os horários das palestras principais.",
                    time: "10:35",
                    type: "sent",
                    status: "read"
                },
                {
                    id: 3,
                    sender: "Carlos Oliveira",
                    message: "A programação completa está no site do evento, mas posso enviar o link aqui.",
                    time: "10:40",
                    type: "received",
                    status: "read"
                },
                {
                    id: 4,
                    sender: "João Silva",
                    message: "Ótimo, obrigado!",
                    time: "10:42",
                    type: "sent",
                    status: "delivered"
                }
            ],
            2: [
                {
                    id: 1,
                    sender: "Maria Santos",
                    message: "O material do workshop já está disponível para download na área do participante.",
                    time: "14:20",
                    type: "received",
                    status: "read",
                    date: "Ontem"
                },
                {
                    id: 2,
                    sender: "João Silva",
                    message: "Perfeito! Já vou baixar aqui. Obrigado!",
                    time: "14:25",
                    type: "sent",
                    status: "read"
                }
            ]
        };

        let currentConversationId = null;
        let currentUser = null;
        const messagesPages = {};
        let selectedUserId = null; // compatibilidade (seleção única)
        let selectedUserIds = new Set();

        // Carregar informações do usuário
        async function loadUserInfo() {
            try {
                const res = await api.get('/auth/profile', { auth: true });
                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user || {};
                    const name = currentUser.name || currentUser.email || 'Usuário';
                    const initial = name.charAt(0).toUpperCase();
                    
                    document.getElementById('userName').textContent = name;
                    document.getElementById('userAvatar').innerHTML = initial;
                    
                    // Atualizar todas as instâncias do nome
                    document.querySelectorAll('.user-name').forEach(el => el.textContent = name);
                    document.querySelectorAll('.user-role').forEach(el => el.textContent = currentUser.role || 'Usuário');
                }
            } catch (e) {
                console.error('Erro ao carregar informações do usuário:', e);
            }
        }

        // Renderizar conversas do array conversationsData
        function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            if (!conversationsList) return;

            conversationsList.innerHTML = conversationsData.map(conversation => {
                const lastSeenText = conversation.online ? 'Online' : conversation.lastSeen;
                const statusIcon = conversation.isGroup ? '<i class="fas fa-users" style="margin-right: 4px; font-size: 12px;"></i>' : '';
                
                return `
                    <div class="conversation-item" data-conversation-id="${conversation.id}">
                        <div class="conversation-avatar">
                            <div class="conversation-avatar-img">
                                ${conversation.name.charAt(0)}
                            </div>
                            ${conversation.online ? '<div class="online-status"></div>' : ''}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <div class="conversation-name">
                                    ${statusIcon}${conversation.name}
                                </div>
                                <div class="conversation-time">${conversation.time}</div>
                            </div>
                            <div class="conversation-last">
                                <div class="conversation-preview">${conversation.lastMessage}</div>
                                ${conversation.unread > 0 ? 
                                    `<div class="conversation-badge">${conversation.unread}</div>` : 
                                    ''
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Adicionar eventos de clique
            conversationsList.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', () => {
                    const conversationId = item.dataset.conversationId;
                    selectConversation(conversationId);
                    
                    // Atualizar seleção visual
                    conversationsList.querySelectorAll('.conversation-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    item.classList.add('active');
                    
                    // Em dispositivos móveis, esconder sidebar
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.add('hidden');
                    }
                });
            });
        }

        // Buscar conversas reais do backend
        async function fetchRealConversations() {
            try {
                const res = await api.get('/chat/conversations', { auth: true });
                const data = res.ok ? await res.json() : { conversations: [] };
                const convs = Array.isArray(data.conversations) ? data.conversations : [];
                conversationsData.length = 0;
                convs.forEach(c => {
                    conversationsData.push({
                        id: c._id,
                        name: c.name,
                        lastMessage: c.lastMessage || '',
                        time: c.time || '',
                        unread: c.unread || 0,
                        participants: [],
                        eventId: null,
                        isGroup: !!c.isGroup,
                        online: false
                    });
                });
                loadConversations();
            } catch (err) {
                console.warn('Falha ao buscar conversas reais', err);
                loadConversations();
            }
        }

        // Selecionar conversa
        function selectConversation(conversationId) {
            currentConversationId = conversationId;
            const conversation = conversationsData.find(c => c.id == conversationId);
            
            if (!conversation) return;

            // Mostrar header do chat
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('chatWithName').textContent = conversation.name;
            document.getElementById('chatStatus').textContent = conversation.online ? 'Online' : conversation.lastSeen;
            
            // Esconder mensagem de "selecione uma conversa"
            document.getElementById('noChatSelected').style.display = 'none';
            
            // Mostrar input de mensagem
            document.getElementById('messageInputContainer').style.display = 'block';
            
            // Carregar mensagens
            loadMessages(conversationId);
            // Realtime: entrar na sala
            if (window.socket) {
                window.socket.emit('chat:join', { conversationId });
            }
            // Controle de paginação
            messagesPages[conversationId] = 1;
            
            // Marcar como lida
            markAsRead(conversationId);
        }

        // Marcar conversa como lida
        function markAsRead(conversationId) {
            const conversation = conversationsData.find(c => c.id == conversationId);
            if (conversation) {
                conversation.unread = 0;
                updateConversationBadge(conversationId);
            }
        }

        // Atualizar badge da conversa
        function updateConversationBadge(conversationId) {
            const conversation = conversationsData.find(c => c.id == conversationId);
            if (!conversation) return;

            const item = document.querySelector(`.conversation-item[data-conversation-id="${conversationId}"]`);
            if (!item) return;

            const badge = item.querySelector('.conversation-badge');
            if (conversation.unread > 0) {
                if (!badge) {
                    const badgeEl = document.createElement('div');
                    badgeEl.className = 'conversation-badge';
                    badgeEl.textContent = conversation.unread;
                    item.querySelector('.conversation-last').appendChild(badgeEl);
                } else {
                    badge.textContent = conversation.unread;
                }
            } else if (badge) {
                badge.remove();
            }
        }

        // Carregar mensagens
        function loadMessages(conversationId) {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.setAttribute('aria-live', 'polite');
            const messages = messagesData[conversationId] || [];

            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #667781;">
                        <i class="fas fa-comment-slash" style="font-size: 64px; margin-bottom: 16px; color: #d1d7db;"></i>
                        <h3 style="font-size: 24px; font-weight: 300; margin-bottom: 8px;">Nenhuma mensagem ainda</h3>
                        <p>Seja o primeiro a enviar uma mensagem!</p>
                    </div>
                `;
                return;
            }

            // Agrupar mensagens por data
            const groupedMessages = groupMessagesByDate(messages);

            messagesContainer.innerHTML = Object.keys(groupedMessages).map(date => {
                const dateMessages = groupedMessages[date];
                const dateDisplay = date === 'Hoje' ? 'HOJE' : date.toUpperCase();
                
                return `
                    <div class="message-group-date">
                        <div class="date-separator">${dateDisplay}</div>
                    </div>
                    ${dateMessages.map(msg => {
                        const isCurrentUser = msg.sender === (currentUser?.name || 'João Silva');
                        const conv = conversationsData.find(c => c.id == conversationId);
                        const showSender = conv?.isGroup && !isCurrentUser;
                        const safeMessage = escapeHTML(String(msg.message ?? ''));
                        
                        return `
                            <div class="message-group ${isCurrentUser ? 'sent' : 'received'}">
                                <div class="message-wrapper">
                                    <div class="message-item ${isCurrentUser ? 'sent' : 'received'}" data-message-id="${msg.id}">
                                        ${showSender ? `<div class="message-sender">${escapeHTML(String(msg.sender || ''))}</div>` : ''}
                                        <div class="message-content">${safeMessage}</div>
                                        <div class="message-info">
                                            <span class="message-time">${msg.time}</span>
                                            ${isCurrentUser ? `
                                                <span class="message-status">
                                                    <i class="fas fa-check${msg.status === 'read' ? '-double' : ''} ${msg.status}"></i>
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }).join('');

            // Rolar para o final
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Infinite scroll: carregar anteriores ao chegar no topo
            messagesContainer.onscroll = () => {
                if (messagesContainer.scrollTop <= 10 && window.socket) {
                    const page = (messagesPages[conversationId] || 1) + 1;
                    window.socket.emit('chat:historyPage', { conversationId, page, limit: 50 });
                }
            };
        }

        // Agrupar mensagens por data
        function groupMessagesByDate(messages) {
            const grouped = {};
            
            messages.forEach(msg => {
                const date = msg.date || 'Hoje';
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(msg);
            });
            
            return grouped;
        }

        // Obter ícone de status
        // Escapar HTML para segurança
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Enviar mensagem (realtime puro)
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.textContent.trim();
            if (!message || !currentConversationId) return;

            // Emitir para o servidor; UI será atualizada via eventos socket
            try {
                if (window.socket) {
                    window.socket.emit('chat:message', { conversationId: currentConversationId, text: message });
                }
            } catch (err) {
                console.warn('Falha ao emitir mensagem realtime', err);
            }

            // Limpar input e manter UX consistente (toggling dos botões)
            messageInput.textContent = '';
            messageInput.focus();
            messageInput.dispatchEvent(new Event('input'));
        }

        // Atualizar status da mensagem
        function updateMessageStatus(messageId, status) {
            const message = document.querySelector(`.message-item[data-message-id="${messageId}"]`);
            if (!message) return;
            const statusIcon = message.querySelector('.message-status i');
            if (statusIcon) {
                statusIcon.className = `fas fa-check${status === 'read' ? '-double' : ''} ${status}`;
            }
        }

        // Obter hora atual formatada
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        // Mostrar modal de novo chat
        function showNewChatModal() {
            const modal = document.getElementById('newChatModal');
            modal.classList.add('active');
            // Por padrão, abrir na aba Usuários e mostrar todos (online/offline)
            try {
                const onlyToggle = document.getElementById('onlyOnlineToggle');
                if (onlyToggle) onlyToggle.checked = false;
                loadUsersForNewChat(true);
            } catch(_) { loadEventsForNewChat(); }
            // Acessibilidade: foco inicial no back
            const back = document.getElementById('modalBackBtn');
            if (back) back.focus();
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('newChatModal').classList.remove('active');
        }

        // Carregar eventos para novo chat
        async function loadEventsForNewChat() {
            const eventList = document.getElementById('eventList');
            
            // Loading
            eventList.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--whatsapp-icon);"></i>
                    <p style="margin-top: 10px; color: #667781;">Carregando eventos...</p>
                </div>
            `;

            let events = [];
            try {
                const res = await api.get('/events', { auth: true });
                if (res.ok) {
                    const data = await res.json();
                    const items = Array.isArray(data?.items) ? data.items : [];
                    events = items.map(e => ({ _id: e.id || e._id, id: e.id || e._id, title: e.title, date: e.date, location: e.location }));
                }
            } catch (err) {
                console.warn('Falha ao buscar eventos no backend. Usando fallback.', err);
            }

            if (!events || events.length === 0) {
                events = [
                    { _id: 'sample-1', id: 'sample-1', title: "Conferência Tech", date: "2026-01-10", location: "São Paulo" }
                ];
            }

            eventList.innerHTML = events.map(event => {
                const eid = event._id || event.id;
                return `
                    <div class="conversation-item" data-event-id="${eid}" style="cursor: pointer;">
                        <div class="conversation-avatar">
                            <div class="conversation-avatar-img">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <div class="conversation-name">${escapeHTML(String(event.title || 'Evento'))}</div>
                            </div>
                            <div class="conversation-last">
                                <div class="conversation-preview">${escapeHTML(String(event.date || 'Em breve'))} • ${escapeHTML(String(event.location || 'A definir'))}</div>
                            </div>
                        </div>
                        <button class="chat-action-btn" style="background: var(--whatsapp-green); color: white;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
            }).join('');

            // Eventos de clique
            eventList.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.chat-action-btn')) {
                        createEventConversation(item.dataset.eventId);
                    }
                });
                const plusBtn = item.querySelector('.chat-action-btn');
                if (plusBtn) {
                    plusBtn.addEventListener('click', () => {
                        createEventConversation(item.dataset.eventId);
                    });
                }
            });
        }

        // Carregar usuários para nova conversa
        let usersPage = 1;
        const usersLimit = 20;
                async function loadUsersForNewChat(reset = true) {
            const list = document.getElementById('eventList');
            if (reset) {
              usersPage = 1;
                      selectedUserId = null;
                      selectedUserIds = new Set();
              list.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--whatsapp-icon);"></i>
                    <p style="margin-top: 10px; color: #667781;">Carregando usuários...</p>
                </div>
              `;
            }
            try {
                const res = await api.get(`/users?page=${usersPage}&limit=${usersLimit}`, { auth: true });
                const data = res.ok ? await res.json() : { users: [] };
                                let users = Array.isArray(data.users) ? data.users : [];
                                // Remover o próprio usuário da lista para evitar erro de userId inválido
                                if (currentUser?._id) {
                                        users = users.filter(u => String(u._id) !== String(currentUser._id));
                                }
                        // Filtrar apenas online se toggle marcado
                        const onlyOnlineEl = document.getElementById('onlyOnlineToggle');
                        const onlyOnline = onlyOnlineEl ? onlyOnlineEl.checked : false;
                        if (onlyOnline) users = users.filter(u => !!u.online);
                if (users.length === 0) {
                    if (reset) list.innerHTML = '<p style="padding:16px;color:#667781;">Nenhum usuário encontrado.</p>';
                    return;
                }
                        const items = users.map(u => `
                            <div class="conversation-item" data-user-id="${u._id}" style="cursor: pointer; display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" class="user-select-checkbox" aria-label="Selecionar usuário" ${selectedUserIds.has(String(u._id)) ? 'checked' : ''}>
                        <div class="conversation-avatar">
                            <div class="conversation-avatar-img">${escapeHTML(String(u.name || u.email || '?')).charAt(0)}</div>
                            ${u.online ? '<div class="online-status"></div>' : ''}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <div class="conversation-name">${escapeHTML(String(u.name || u.email || 'Usuário'))}</div>
                            </div>
                            <div class="conversation-last">
                                <div class="conversation-preview">${escapeHTML(String(u.email || ''))}${u.online ? ' • Online' : (u.lastSeen ? ' • Último acesso ' + new Date(u.lastSeen).toLocaleString('pt-BR') : '')}</div>
                            </div>
                        </div>
                        <button class="chat-action-btn" style="background: var(--whatsapp-green); color: white;">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                `).join('');

                if (reset) list.innerHTML = items; else list.insertAdjacentHTML('beforeend', items);

                list.querySelectorAll('.conversation-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.chat-action-btn')) {
                            const uid = item.dataset.userId;
                            // Toggle seleção múltipla
                            const key = String(uid);
                            if (selectedUserIds.has(key)) selectedUserIds.delete(key); else selectedUserIds.add(key);
                            // Mantém compatibilidade de seleção única
                            selectedUserId = key;
                            // Atualiza UI
                            const cb = item.querySelector('.user-select-checkbox');
                            if (cb) cb.checked = selectedUserIds.has(key);
                            item.classList.toggle('active', selectedUserIds.has(key));
                            // Habilita botão
                            const startBtn = document.getElementById('startDmBtn');
                            if (startBtn) startBtn.disabled = selectedUserIds.size === 0;
                        }
                    });
                    const btn = item.querySelector('.chat-action-btn');
                    btn?.addEventListener('click', () => {
                        const uid = item.dataset.userId;
                        const user = users.find(x => String(x._id) === String(uid));
                        if (user) createDMConversation(user);
                    });
                });

                // Carregar mais
                const loadMoreId = 'loadMoreUsersBtn';
                let loadMore = document.getElementById(loadMoreId);
                if (!loadMore) {
                  loadMore = document.createElement('button');
                  loadMore.id = loadMoreId;
                  loadMore.className = 'chat-action-btn';
                  loadMore.style.cssText = 'background:#e9edef;border-radius:6px;width:100%;height:auto;padding:8px 10px;color:#111b21;font-size:14px;margin-top:8px;';
                  loadMore.textContent = 'Carregar mais';
                  list.appendChild(loadMore);
                }
                loadMore.onclick = () => { usersPage += 1; loadUsersForNewChat(false); };

                // Ação do botão Iniciar DM
                const startBtn = document.getElementById('startDmBtn');
                if (startBtn) {
                    startBtn.disabled = selectedUserIds.size === 0;
                    startBtn.onclick = async () => {
                        if (selectedUserIds.size === 0) return;
                        startBtn.disabled = true;
                        const original = startBtn.innerHTML;
                        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
                        try {
                            if (selectedUserIds.size === 1) {
                                const [onlyId] = Array.from(selectedUserIds);
                                await createDMConversationById(onlyId);
                            } else {
                                const ids = Array.from(selectedUserIds);
                                await createGroupConversationByIds(ids);
                            }
                        } finally {
                            startBtn.innerHTML = original;
                            startBtn.disabled = false;
                        }
                    };
                }
            } catch (err) {
                console.error('Falha ao carregar usuários', err);
                list.innerHTML = '<p style="padding:16px;color:#a33;">Erro ao carregar usuários.</p>';
            }
        }

        function dmConversationIdFor(userAId, userBId) {
            const [a, b] = [String(userAId), String(userBId)].sort();
            return `dm:${a}-${b}`;
        }

        async function createDMConversation(user) {
            if (!currentUser?._id) {
                // currentUser obtido via /auth/profile; fallback se não houver
                currentUser = { _id: 'me', name: currentUser?.name || 'Você' };
            }
            // Solicitar ao backend a criação/garantia da DM
            try {
                const res = await api.post('/chat/conversations/dm', { userId: user._id }, { auth: true });
                if (!res.ok) throw new Error('Falha ao criar DM');
                const data = await res.json();
                const conv = data.conversation;
                // Atualizar lista e abrir
                const existing = conversationsData.find(c => String(c.id) === String(conv._id));
                if (!existing) {
                    conversationsData.unshift({
                        id: conv._id,
                        name: conv.name,
                        lastMessage: 'Conversa iniciada',
                        time: 'Agora',
                        unread: 0,
                        participants: [],
                        eventId: null,
                        isGroup: false,
                        online: true
                    });
                }
                messagesData[conv._id] = messagesData[conv._id] || [];
                loadConversations();
                selectConversation(conv._id);
                closeModal();
                showToast('Conversa com usuário criada!');
            } catch (err) {
                console.error('Falha ao criar DM', err);
                showToast('Erro ao criar conversa');
            }
        }

        async function createDMConversationById(userId) {
            if (!userId) return;
            try {
                const res = await api.post('/chat/conversations/dm', { userId }, { auth: true });
                if (!res.ok) {
                    const msg = 'Falha ao criar DM';
                    try { const body = await res.json(); showToast(body?.error || msg); } catch(_) { showToast(msg); }
                    return;
                }
                const data = await res.json();
                const conv = data.conversation;
                const existing = conversationsData.find(c => String(c.id) === String(conv._id));
                if (!existing) {
                    conversationsData.unshift({
                        id: conv._id,
                        name: conv.name,
                        lastMessage: 'Conversa iniciada',
                        time: 'Agora',
                        unread: 0,
                        participants: [],
                        eventId: null,
                        isGroup: false,
                        online: true
                    });
                }
                messagesData[conv._id] = messagesData[conv._id] || [];
                loadConversations();
                selectConversation(conv._id);
                closeModal();
                showToast('DM criada com sucesso!');
            } catch (err) {
                console.error('Falha ao criar DM por ID', err);
                showToast('Erro ao criar conversa');
            }
        }

        async function createGroupConversationByIds(userIds) {
            if (!Array.isArray(userIds) || userIds.length < 2) {
                return showToast('Selecione 2 ou mais usuários');
            }
            try {
                const title = 'Conversa';
                const res = await api.post('/chat/conversations/group', { userIds, title }, { auth: true });
                if (!res.ok) {
                    const msg = 'Falha ao criar conversa de grupo';
                    try { const body = await res.json(); showToast(body?.error || msg); } catch(_) { showToast(msg); }
                    return;
                }
                const data = await res.json();
                const conv = data.conversation;
                const existing = conversationsData.find(c => String(c.id) === String(conv._id));
                if (!existing) {
                    conversationsData.unshift({
                        id: conv._id,
                        name: conv.name || 'Grupo',
                        lastMessage: 'Conversa criada',
                        time: 'Agora',
                        unread: 0,
                        participants: [],
                        eventId: null,
                        isGroup: true,
                        online: false
                    });
                }
                messagesData[conv._id] = messagesData[conv._id] || [];
                loadConversations();
                selectConversation(conv._id);
                closeModal();
                showToast('Conversa de grupo criada!');
            } catch (err) {
                console.error('Falha ao criar conversa de grupo', err);
                showToast('Erro ao criar conversa de grupo');
            }
        }

        // Criar/garantir conversa de evento via backend
        async function createEventConversation(eventId) {
            try {
                const res = await api.post('/chat/conversations/event', { eventId }, { auth: true });
                if (!res.ok) throw new Error('Falha ao criar conversa de evento');
                const data = await res.json();
                const conv = data.conversation;
                // Atualizar lista e abrir
                const existing = conversationsData.find(c => String(c.id) === String(conv._id));
                if (!existing) {
                    conversationsData.unshift({
                        id: conv._id,
                        name: conv.name,
                        lastMessage: 'Conversa iniciada sobre o evento',
                        time: 'Agora',
                        unread: 0,
                        participants: [],
                        eventId: conv.eventId || eventId,
                        isGroup: true,
                        online: false
                    });
                }
                messagesData[conv._id] = messagesData[conv._id] || [];
                loadConversations();
                selectConversation(conv._id);
                closeModal();
                showToast('Conversa do evento criada!');
            } catch (err) {
                console.error('Falha ao criar conversa de evento', err);
                showToast('Erro ao criar conversa do evento');
            }
        }

        // Mostrar toast
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--whatsapp-dark);
                color: white;
                padding: 12px 24px;
                border-radius: 24px;
                font-size: 14px;
                z-index: 10000;
                animation: fadeInOut 3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Voltar para tela inicial
        function backToHome() {
            try {
                window.location.href = '../index.html';
            } catch (e) {
                // Fallback: se falhar, tenta raiz
                window.location.assign('../index.html');
            }
        }

        // Inicializar tudo
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificação obrigatória
            try { const ok = await api.requireVerified(); if (!ok) return; } catch(_) { return; }
            await loadUserInfo();
            await fetchRealConversations();
            // Conectar Socket.IO
            try {
                const base = (typeof window.API_BASE_URL !== 'undefined' && window.API_BASE_URL) ? window.API_BASE_URL : '';
                window.socket = io(base, {
                    transports: ['websocket'],
                    auth: { token: api.token.get() }
                });

                // Receber histórico ao entrar
                window.socket.on('chat:history', ({ conversationId, messages }) => {
                    messagesData[conversationId] = (messages || []).map(m => ({
                        id: m._id || m.id,
                        sender: m.senderName,
                        message: m.text,
                        time: m.time,
                        type: m.senderName === (currentUser?.name || 'João Silva') ? 'sent' : 'received',
                        status: 'delivered',
                        date: 'Hoje'
                    }));
                    if (String(conversationId) === String(currentConversationId)) {
                        loadMessages(currentConversationId);
                    }
                });

                // Receber histórico paginado
                window.socket.on('chat:historyPage', ({ conversationId, page, messages }) => {
                    const arr = (messages || []).map(m => ({
                        id: m._id || m.id,
                        sender: m.senderName,
                        message: m.text,
                        time: m.time,
                        type: m.senderName === (currentUser?.name || 'João Silva') ? 'sent' : 'received',
                        status: 'delivered',
                        date: 'Hoje'
                    }));
                    const container = document.getElementById('messagesContainer');
                    const prevHeight = container.scrollHeight;
                    messagesData[conversationId] = (messagesData[conversationId] || []);
                    messagesData[conversationId] = arr.concat(messagesData[conversationId]);
                    messagesPages[conversationId] = page;
                    if (String(conversationId) === String(currentConversationId)) {
                        loadMessages(currentConversationId);
                        // manter posição próxima ao carregamento anterior
                        container.scrollTop = container.scrollHeight - prevHeight;
                    }
                });

                // Receber novas mensagens
                window.socket.on('chat:message', ({ conversationId, message }) => {
                    const msg = {
                        id: message.id,
                        sender: message.senderName,
                        message: message.text,
                        time: message.time,
                        type: message.senderName === (currentUser?.name || 'João Silva') ? 'sent' : 'received',
                        status: 'delivered',
                        date: 'Hoje'
                    };
                    messagesData[conversationId] = messagesData[conversationId] || [];
                    messagesData[conversationId].push(msg);
                    // Atualiza preview e badges na lista de conversas
                    const conv = conversationsData.find(c => String(c.id) === String(conversationId));
                    if (conv) {
                        conv.lastMessage = message.text;
                        conv.time = 'Agora';
                    }
                    if (String(conversationId) === String(currentConversationId)) {
                        loadMessages(currentConversationId);
                        // conversa ativa: marca como lida
                        if (conv) { conv.unread = 0; }
                    } else {
                        // incrementa badge da conversa não ativa
                        if (conv) { conv.unread = (conv.unread || 0) + 1; }
                        updateConversationBadge(conversationId);
                    }
                    // Re-renderiza lista para refletir última mensagem/tempo
                    loadConversations();
                });

                // Indicador de digitação
                window.socket.on('chat:typing', ({ conversationId }) => {
                    if (String(conversationId) === String(currentConversationId)) {
                        showTypingIndicator();
                    }
                });

                // Presença
                window.socket.on('presence:update', ({ userId, online, lastSeen }) => {
                    // Atualiza badges na lista de usuários
                    document.querySelectorAll(`.conversation-item[data-user-id="${userId}"] .online-status`).forEach(el => el.remove());
                    const item = document.querySelector(`.conversation-item[data-user-id="${userId}"] .conversation-avatar`);
                    if (item && online) {
                        const dot = document.createElement('div');
                        dot.className = 'online-status';
                        item.appendChild(dot);
                    }
                    // Atualiza header de conversa se for DM com esse usuário
                    const dmPrefix = 'dm:';
                    const isDmWithUser = String(currentConversationId || '').startsWith(dmPrefix) && String(currentConversationId).includes(String(userId));
                    if (isDmWithUser) {
                        document.getElementById('chatStatus').textContent = online ? 'Online' : (lastSeen ? 'Última vez ' + new Date(lastSeen).toLocaleString('pt-BR') : 'Offline');
                    }
                });

            } catch (err) {
                console.warn('Falha ao conectar Socket.IO', err);
            }

            const backBtn = document.getElementById('backBtn');
            if (backBtn) backBtn.addEventListener('click', backToHome);
            // Botão voltar
            document.getElementById('backToListBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('hidden');
            });
            document.getElementById('tabUsersBtn').addEventListener('click', loadUsersForNewChat);
            document.getElementById('tabEventsBtn').addEventListener('click', loadEventsForNewChat);
            document.getElementById('modalBackBtn').addEventListener('click', closeModal);
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            const onlyToggle = document.getElementById('onlyOnlineToggle');
            if (onlyToggle) {
                onlyToggle.addEventListener('change', () => loadUsersForNewChat(true));
            }
            const newChatBtn = document.getElementById('newChatBtn');
            if (newChatBtn) {
                newChatBtn.addEventListener('click', () => {
                    showNewChatModal();
                    // Garante que a lista atual seja de usuários ao abrir
                    loadUsersForNewChat(true);
                });
            }

            // Inicialização estado voice/send
            const messageInput = document.getElementById('messageInput');
            const voiceBtn = document.getElementById('voiceBtn');
            const sendBtn = document.getElementById('sendMessageBtn');
            if (!messageInput.textContent.trim()) {
                voiceBtn.style.display = 'flex';
                sendBtn.style.display = 'none';
            } else {
                voiceBtn.style.display = 'none';
                sendBtn.style.display = 'flex';
            }

            // Paste seguro (texto puro)
            messageInput.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                document.execCommand('insertText', false, text);
            });

            // Enviar com Enter
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                // Emite typing quando teclas comuns
                if (window.socket && currentConversationId && e.key.length === 1) {
                    window.socket.emit('chat:typing', { conversationId: currentConversationId });
                }
                if (e.key === 'Escape') {
                    // Esc fecha modal
                    const modal = document.getElementById('newChatModal');
                    if (modal.classList.contains('active')) closeModal();
                }
            });

            // Fechar modal ao clicar fora
            document.getElementById('newChatModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('newChatModal')) {
                    closeModal();
                }
            });

            // Botão de menu do usuário
            document.getElementById('menuBtn').addEventListener('click', () => {
                // Simular menu de opções
                showToast('Menu de opções');
            });

            // Botão de emoji
            document.getElementById('emojiBtn').addEventListener('click', () => {
                showToast('Emojis em breve!');
            });

            // Botão de anexo (imagem preview simples)
            const attachmentInput = document.getElementById('attachmentInput');
            document.getElementById('attachmentBtn').addEventListener('click', () => {
                attachmentInput.click();
            });
            attachmentInput.addEventListener('change', () => {
                const file = attachmentInput.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    if (!currentConversationId) return;
                    const newMessage = {
                        id: Date.now(),
                        sender: currentUser?.name || 'João Silva',
                        message: '[imagem]',
                        time: getCurrentTime(),
                        type: 'sent',
                        status: 'sent',
                        date: 'Hoje',
                        imageDataUrl: reader.result
                    };
                    if (!messagesData[currentConversationId]) messagesData[currentConversationId] = [];
                    messagesData[currentConversationId].push(newMessage);
                    // render com imagem
                    loadMessages(currentConversationId);
                    attachmentInput.value = '';
                };
                reader.readAsDataURL(file);
            });

            // Responsividade: toggle sidebar em mobile
            document.getElementById('chatHeader').addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && e.target.closest('.chat-user-info')) {
                    document.getElementById('sidebar').classList.remove('hidden');
                }
            });

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if (confirm('Tem certeza que deseja sair?')) {
                        api.token.clear();
                        window.location.href = '../index.html';
                    }
                });
            }

            // Auto-expandir input
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Mostrar/ocultar botão de voz
                if (this.textContent.trim()) {
                    voiceBtn.style.display = 'none';
                    sendBtn.style.display = 'flex';
                } else {
                    voiceBtn.style.display = 'flex';
                    sendBtn.style.display = 'none';
                }
            });
            // Toggle sidebar explicit (mobile)
            document.getElementById('toggleSidebarBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('hidden');
            });

            // Busca de conversas
            const searchInput = document.getElementById('conversationSearchInput');
            searchInput.addEventListener('input', () => {
                const term = searchInput.value.toLowerCase();
                const items = document.querySelectorAll('.conversation-item');
                items.forEach(item => {
                    const nameEl = item.querySelector('.conversation-name');
                    const previewEl = item.querySelector('.conversation-preview');
                    const text = `${nameEl?.textContent || ''} ${previewEl?.textContent || ''}`.toLowerCase();
                    item.style.display = text.includes(term) ? '' : 'none';
                });
            });

            // Carregar conversa padrão se houver
            if (conversationsData.length > 0) {
                const firstConv = document.querySelector('.conversation-item');
                if (firstConv) {
                    firstConv.click();
                }
            }
        });

        // Adicionar estilos CSS dinâmicos
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translate(-50%, 20px); }
                10% { opacity: 1; transform: translate(-50%, 0); }
                90% { opacity: 1; transform: translate(-50%, 0); }
                100% { opacity: 0; transform: translate(-50%, -20px); }
            }
            
            .message-item[data-message-id] {
                position: relative;
            }
            
            /* Indicador de nova mensagem */
            .new-message-indicator {
                position: absolute;
                bottom: 10px;
                right: 10px;
                background: var(--whatsapp-green);
                color: white;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Indicador de digitação (UX)
        function showTypingIndicator() {
            const container = document.getElementById('messagesContainer');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            container.appendChild(indicator);
            setTimeout(() => indicator.remove(), 1500);
        }

        // Mantém indicador apenas para eventos recebidos (ver socket 'chat:typing')
    </script>
</body>
</html>